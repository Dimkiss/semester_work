# Семестровая работа

## Установка и запуск проекта

### 1. Клонирование репозитория
```
git clone https://github.com/Dimkiss/semester_work.git
cd semester_work
```

### 2. Создание виртуального окружения

```
python -m venv venv
```

#### Linux / macOS

```
python3 -m venv venv
```

### 3. Активация виртуального окружения

#### Windows (PowerShell)

```
venv\Scripts\activate
```

#### Windows (cmd)

```
venv\Scripts\activate.bat
```

#### Linux / macOS

```
source venv/bin/activate
```

После активации в начале строки терминала должно появиться `(venv)`.

### 4. Установка зависимостей

```
pip install -r requirements.txt
```
## Структура проекта и описание файлов

### data/

#### `data/all_tables/`
CSV-файлы исходных таблиц, полученных из датасета RF200.

#### `data/test_set/`
JSON-файлы с ручной разметкой (gold standard) для оценки качества NER.

### outputs/

Содержит результаты работы моделей NER:
- `*_spacy.json` — результаты NER с помощью spaCy  
- `*_gigachat_zero.json` — результаты GigaChat (zero-shot)
- `*_gigachat_few.json` — результаты GigaChat (few-shot)
- `*_nel.json` — результаты после NEL (Entity Linking)

### reports/

Содержит отчёты оценки качества NER:
- `ner_report_spacy.json`
- `ner_report_gigachat_zero.json`
- `ner_report_gigachat_few.json`

### src/

#### `table_load.py`
Загрузчик CSV-таблиц RF200 с автоматическим определением разделителя и структуры.  
Позволяет:
- автоматически определить разделитель (`|`, `;`, `,`, `\t`)
- удалить служебный первый столбец (нумерацию)
- преобразовать таблицу в плоский список ячеек для NER

Используется для подготовки входных данных для NER. 

**Используется внутри проекта**, напрямую обычно не вызывается, а импортируется в `run.py` / `run_gigachat.py`.

**Основные возможности:**

* автоматическое определение разделителя (`| ; , \t`)
* удаление служебного первого столбца (нумерация)
* формирование плоского списка ячеек таблицы
* корректная индексация строк и столбцов
Отлично, теперь кратко и аккуратно опишу **запуск и параметры остальных файлов** — в формате, готовом для README или отчёта.

---

#### `batch_run.py` — пакетный запуск spaCy NER

**Назначение:**
Автоматически запускает spaCy NER для набора таблиц RF200.

**Как работает:**
Проходит по диапазону `table_id` и вызывает `run.py` для каждой таблицы 

**Запуск:**

```bash
python src/batch_run.py
```

**Параметры:**
не принимает аргументы командной строки
Настраивается внутри файла:

* диапазон таблиц: `for table_id in range(201, 226)`
* вход: `data/all_tables`
* выход: `outputs/{table_id}_spacy.json`
* `index_base = 1` — индексация строк и столбцов с 1

---

#### `run.py` — запуск spaCy NER для одной таблицы

**Назначение:**
Запуск NER на базе spaCy для одной CSV-таблицы RF200 

**Запуск:**

```bash
python src/run.py --tables_dir data/all_tables --table_id 201 --out outputs/201_spacy.json
```

**Параметры:**

* `--tables_dir` — путь к CSV-таблицам
* `--table_id` — номер таблицы
* `--out` — путь к выходному JSON
* `--model` — spaCy-модель (по умолчанию `ru_core_news_lg`)
* `--drop_first_col` — `auto | true | false`
* `--drop_header` — `true | false`
* `--index_base` — `0` или `1`
* `--quiet` — отключить вывод

---

#### `ner_spacy.py` — NER через spaCy

**Назначение:**
Извлекает сущности из текста ячейки с помощью spaCy и правила для чисел (QUANTITY) 

**Использование:**
Используется внутри `run.py`, напрямую не запускается.

**Особенности:**

* поддержка стандартных spaCy-сущностей
* правило для числовых значений (QUANTITY)

---

#### `ner_gigachat.py` — NER через GigaChat

**Назначение:**
NER на основе LLM GigaChat в режимах zero-shot и few-shot 

**Использование:**
Используется внутри `run_gigachat.py`, напрямую не запускается.

**Режимы:**

* `zero` — без примеров
* `few` — с примерами в промпте

---

#### `run_gigachat.py` — запуск GigaChat NER для одной таблицы

**Назначение:**
Запуск NER через GigaChat для одной таблицы RF200 

**Запуск:**

```bash
python src/run_gigachat.py --tables_dir data/all_tables --table_id 201 --out outputs/201_gigachat_zero.json --mode zero
```

**Параметры:**

* `--tables_dir` — путь к CSV
* `--table_id` — номер таблицы
* `--out` — путь к выходному JSON
* `--mode` — `zero | few`
* `--credentials` — API-ключ (если не задан через env)
* `--drop_first_col` — `auto | true | false`
* `--drop_header` — `true | false`
* `--index_base` — `0 | 1`
* `--quiet` — отключить вывод

---

#### `batch_run_gigachat.py` — пакетный запуск GigaChat NER

**Назначение:**
Автоматический запуск GigaChat NER для диапазона таблиц и выбранных режимов 

**Запуск:**

```bash
python src/batch_run_gigachat.py
```

**Настройки внутри файла:**

* `MODES = ["few"]` — можно указать `["zero", "few"]`
* `TABLE_RANGE = range(201, 226)`
* выход: `outputs/{id}_gigachat_{mode}.json`

---

#### `nel_wikidata.py` — NEL через Wikidata

**Назначение:**
Связывает сущности с объектами Wikidata по тексту сущности 

**Использование:**
Используется в `run_nel.py`, напрямую не запускается.

**Особенности:**

* фильтрация только русских сущностей
* кеширование запросов
* ограничение числа кандидатов (`limit`)

---

#### `run_nel.py` — применение NEL к одному файлу

**Назначение:**
Добавляет `kb_id` (Wikidata) к сущностям в NER-JSON. С включенным прокси может возвращать ошибки.
**Запуск:**

```bash
python src/run_nel.py --in_ner outputs/201_spacy.json --out outputs/201_spacy_nel.json
```

**Параметры:**

* `--in_ner` — входной NER JSON
* `--out` — выходной JSON с NEL
* `--limit` — сколько кандидатов брать из Wikidata
* `--sleep` — пауза между запросами
* `--quiet` — отключить вывод

---

#### `batch_run_nel.py` — пакетный запуск NEL

**Назначение:**
Применяет NEL ко всем результатам NER в папке `outputs` 

**Запуск:**

```bash
python src/batch_run_nel.py
```

**Особенности:**

* пропускает файлы `*_nel.json`
* сохраняет результат с суффиксом `_nel.json`
* не требует аргументов

---

#### `eval_ner.py` — оценка качества NER

**Назначение:**
Автоматическая оценка spaCy, GigaChat zero-shot и few-shot по test_set 

**Запуск:**

```bash
python src/eval_ner.py
```
Вот `nel_stats.py` в **точно таком же формате**, как ты просишь:

---

#### `nel_stats.py` — статистика качества NEL

**Назначение:**
Подсчёт эффективности этапа связывания сущностей (Entity Linking) для моделей spaCy, GigaChat zero-shot и few-shot без использования ручной разметки.

**Запуск:**

```
python src/nel_stats.py
```

**Параметры:**

* `--pred_dir` — папка с результатами (по умолчанию `outputs`)
* `--test_set_dir` — папка с ручной разметкой (`data/test_set`)
* `--reports_dir` — куда сохранять отчёты (`reports`)
* `--label_map` — сопоставление меток, если отличаются(например `GPE=LOC`)
* `--exclude_labels` — исключаемые метки
* `--per_label` — считать метрики по каждой метке
* `--min_id`, `--max_id` — диапазон таблиц


#### `csv_to_json_template.py`
Скрипт для преобразования CSV в JSON-шаблон для ручной разметки.  
Формирует структуру:
```json
{
  "table_name": "...",
  "method": "manual",
  "results": [{ "row": ..., "col": ..., "text": ..., "entities": [] }]
}
```
**Запуск:**

```bash
python src/csv_to_json_template.py --input data/all_tables/file_name.csv --output data/test_set/file_name.json
```

**Доступные параметры запуска:**

* `--input` — путь к CSV-файлу
* `--output` — путь для сохранения JSON-шаблона
* `--drop_first_col` — удалить первый столбец (нумерацию), `yes/no`
* `--drop_header` — удалить строку заголовка, `yes/no` по дефолту `yes`

**Пример:**

```bash
py csv_to_json_template.py "data\all_tables\221_locations_table.csv" -o "data\test_set\221_locations_table.json" --drop-first-col yes
```

## Типы сущностей, используемые в проекте

| Метка           | Описание                                                             |
| --------------- | -------------------------------------------------------------------- |
| **PER**         | Имя человека, персона                                                |
| **ORG**         | Организация, компания, учреждение                                    |
| **LOC**         | Конкретное место: город, деревня, географический объект              |
| **GPE**         | Геополитическая территория: страна, регион, административная единица |
| **DATE**        | Дата, год, период времени                                            |
| **TIME**        | Время                                                                |
| **MONEY**       | Денежные суммы                                                       |
| **PERCENT**     | Проценты                                                             |
| **QUANTITY**    | Количество или мера                                                  |
| **EVENT**       | Событие                                                              |
| **WORK_OF_ART** | Произведение искусства, фильм, книга, картина и т.п.                 |
| **PRODUCT**     | Продукты, товары, модели техники                                     |
| **LAW**         | Законы, нормативные акты                                             |
| **LANGUAGE**    | Языки                                                                |
| **NORP**        | Национальности, религиозные и политические группы                    |
| **FAC**         | Здания, сооружения, аэропорты, инфраструктура                        |
| **MISC**        | Прочие значимые объекты                                              |

## Отчёты оценки качества NER

Оценка проводилась по ручной разметке из `data/test_set` с использованием скрипта `eval_ner.py`.
Для каждой модели сформирован отдельный JSON-отчёт в папке `reports/`.

Метрики рассчитывались по стандартным формулам:

* **Precision** — доля правильно найденных сущностей среди всех найденных
* **Recall** — доля найденных сущностей от всех существующих в разметке
* **F1-score** — гармоническое среднее Precision и Recall


### spaCy NER — `ner_report_spacy.json`

Итоговые метрики:

* **Precision:** 0.5107
* **Recall:** 0.2729
* **F1-score:** 0.3557

Общее количество:

* Correct (C): 381
* Predicted (A): 746
* Gold (N): 1396

spaCy демонстрирует умеренную точность, но низкую полноту: модель часто пропускает сущности, особенно в сложных спортивных таблицах. Русская модель для spaCy имеет всего три сущности['LOC', 'ORG', 'PER'], так что её точность оставляет жедать лучшего.

### GigaChat zero-shot — `ner_report_gigachat_zero.json`

Итоговые метрики:

* **Precision:** 0.5236
* **Recall:** 0.1110
* **F1-score:** 0.1832

Общее количество:

* Correct (C): 155
* Predicted (A): 296
* Gold (N): 1396

Zero-shot режим показывает крайне низкую полноту: модель извлекает мало сущностей, хотя среди них значительная часть корректна. Подходит только как базовый ориентир.

### GigaChat few-shot — `ner_report_gigachat_few.json`

Итоговые метрики:

* **Precision:** 0.6811
* **Recall:** 0.3947
* **F1-score:** 0.4998

Общее количество:

* Correct (C): 551
* Predicted (A): 809
* Gold (N): 1396

Few-shot режим показал лучшие результаты:
значительно выросли и точность, и полнота по сравнению с zero-shot и spaCy.

---

### Сравнение моделей

| Модель             | Precision | Recall | F1-score |
| ------------------ | --------- | ------ | -------- |
| spaCy              | 0.5107    | 0.2729 | 0.3557   |
| GigaChat zero-shot | 0.5236    | 0.1110 | 0.1832   |
| GigaChat few-shot  | 0.6811    | 0.3947 | 0.4998   |

---

Вот короткое и аккуратное описание для отчёта на основе твоих данных:

---

## Результаты NEL (связывание сущностей)

Для оценки этапа Entity Linking была рассчитана доля сущностей, для которых удалось подобрать соответствующий объект в базе знаний Wikidata (linking coverage).

| Модель             | Всего сущностей | Связано | Покрытие |
| ------------------ | --------------- | ------- | -------- |
| GigaChat few-shot  | 809             | 386     | 47.71%   |
| GigaChat zero-shot | 296             | 238     | 80.41%   |
| spaCy              | 746             | 274     | 36.73%   |

## Выводы
### NER

* **GigaChat few-shot** показал наилучшее качество извлечения сущностей среди всех рассмотренных моделей.
* **GigaChat zero-shot** режим оказался непригодным для практического использования из-за низкой полноты.
* **spaCy** обеспечивает стабильный базовый уровень, но уступает few-shot LLM по всем ключевым метрикам.

### NEL
* **GigaChat zero-shot** показал наибольшее покрытие связывания (80.41%), что связано с тем, что модель извлекает меньше, но более “чётких” и легко связываемых сущностей.
* **GigaChat few-shot** извлекает значительно больше сущностей, однако доля успешно связанных ниже из-за наличия более сложных и неоднозначных упоминаний.
* **spaCy** демонстрирует наименьшее покрытие связывания, что объясняется более шумным и фрагментированным извлечением сущностей.

Таким образом, этап NEL наиболее стабильно работает для сущностей, полученных в zero-shot режиме, однако наибольшую полноту по количеству сущностей обеспечивает few-shot модель.
